 <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>BLE Graph â€“ Stable</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial; padding: 20px; background:#f0f8ff; }
  #status { margin-bottom: 10px; font-size: 14px; color: #333; }
  canvas { width: 100% !important; max-width: 900px; height: 350px !important; }
  button { padding: 10px 14px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; margin-right:10px; }
</style>
</head>
<body>

<h2>Stable BLE Sensor Graph (No Infinite Scroll)</h2>
<div id="status">Status: Idle</div>

<button onclick="connectBLE()">Connect BLE</button>

<canvas id="chart"></canvas>

<script>
const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const ACCEL_UUID   = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const RGB_UUID     = "beb5483e-36e1-4688-b7f5-ea07361b26b0";

// âš¡ Keep ONLY latest 50 points â€” NO infinite graph
const MAX_POINTS = 50;

let accelChar, rgbChar, lastA=null, lastR=null;

const ctx = document.getElementById("chart").getContext("2d");
const chart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label:"Activity (g)", data:[], borderColor:"red", borderWidth:1 },
            { label:"Brightness", data:[], borderColor:"blue", borderWidth:1 },
            { label:"Blue Ratio", data:[], borderColor:"orange", borderWidth:1 }
        ]
    },
    options: {
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        scales:{ x:{ ticks:{ maxTicksLimit:10 }} }
    }
});

function updateStatus(t){ document.getElementById("status").innerText = "Status: "+t; }

async function connectBLE(){
    try{
        updateStatus("Requesting device...");
        let device = await navigator.bluetooth.requestDevice({
            filters:[{ services:[SERVICE_UUID] }],
            optionalServices:[SERVICE_UUID]
        });
        updateStatus("Connecting...");
        let server = await device.gatt.connect();
        let service = await server.getPrimaryService(SERVICE_UUID);

        accelChar = await service.getCharacteristic(ACCEL_UUID);
        rgbChar   = await service.getCharacteristic(RGB_UUID);

        accelChar.startNotifications();
        rgbChar.startNotifications();

        accelChar.addEventListener("characteristicvaluechanged", e=>{
            let txt = new TextDecoder().decode(e.target.value);
            lastA = txt.split(",").map(Number);
            pushData();
        });

        rgbChar.addEventListener("characteristicvaluechanged", e=>{
            let txt = new TextDecoder().decode(e.target.value);
            lastR = txt.split(",").map(Number);
            pushData();
        });

        updateStatus("Connected");
    }catch(e){
        updateStatus("Error: "+e);
    }
}

function pushData(){
    if(!lastA || !lastR) return;

    let ax=lastA[0], ay=lastA[1], az=lastA[2];
    let activity = Math.sqrt(ax*ax+ay*ay+az*az);

    let r=lastR[0], g=lastR[1], b=lastR[2], c=lastR[3];
    let blueRatio = c>0 ? b/c : 0;

    let time = new Date().toLocaleTimeString();

    // ðŸ”¥ Keep graph ALWAYS at 50 points
    if(chart.data.labels.length >= MAX_POINTS){
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
    }

    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(activity);
    chart.data.datasets[1].data.push(c);
    chart.data.datasets[2].data.push(blueRatio);

    chart.update();

    // reset pairing
    lastA=null; lastR=null;
}
</script>

</body>
</html>
