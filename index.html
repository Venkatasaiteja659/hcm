  /*
  Robust BLE broadcaster for ESP32
  - Advertises service UUID and exposes two notify characteristics:
    ACCEL_CHAR_UUID -> "ax,ay,az"
    RGB_CHAR_UUID   -> "r,g,b,c"
  - If sensors fail, it will still advertise and send demo values so the web page can connect.
  - Upload, then open Serial Monitor at 115200 for debug logs.
*/

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <Wire.h>

// Optional sensor libraries (uncomment if using them)
// #include <Adafruit_MPU6050.h>
// #include <Adafruit_Sensor.h>
// #include <Adafruit_TCS34725.h>

// If you have the Adafruit libs installed, uncomment the two lines below and the .begin() calls
// Adafruit_MPU6050 mpu;
// Adafruit_TCS34725 tcs = Adafruit_TCS34725(TCS34725_INTEGRATIONTIME_2_4MS, TCS34725_GAIN_1X);

#define SERVICE_UUID           "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define ACCEL_CHAR_UUID        "beb5483e-36e1-4688-b7f5-ea07361b26a8"
#define RGB_CHAR_UUID          "beb5483e-36e1-4688-b7f5-ea07361b26b0"

BLECharacteristic *pAccelCharacteristic;
BLECharacteristic *pRGBCharacteristic;
bool sensorsPresent = false;

class MyServerCallbacks: public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) {
    Serial.println("BLE Client Connected");
  }
  void onDisconnect(BLEServer* pServer) {
    Serial.println("BLE Client Disconnected - restarting advertising");
    // Restart advertising so browser/phone can reconnect
    BLEDevice::startAdvertising();
  }
};

String floatToStr(float v, int digits=2) {
  char buf[24];
  dtostrf(v, 0, digits, buf);
  return String(buf);
}

void setupSensors() {
  sensorsPresent = false;
  Wire.begin();

  // Try MPU6050
  bool okMPU = false;
  // Uncomment if using Adafruit MPU library:
  /*
  if (mpu.begin()) {
    Serial.println("MPU6050 found");
    mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
    mpu.setGyroRange(MPU6050_RANGE_500_DEG);
    okMPU = true;
  } else {
    Serial.println("MPU6050 not found");
  }
  */

  // Try TCS34725
  bool okTCS = false;
  // Uncomment if using Adafruit TCS library:
  /*
  if (tcs.begin()) {
    Serial.println("TCS34725 found");
    okTCS = true;
  } else {
    Serial.println("TCS34725 not found");
  }
  */

  // If both sensors are present set true. For demo purpose we'll allow either.
  sensorsPresent = (okMPU || okTCS);
  if (sensorsPresent) Serial.println("At least one sensor detected, running live mode.");
  else Serial.println("No sensors detected - running demo broadcast mode.");
}

void setup() {
  Serial.begin(115200);
  Serial.println();
  Serial.println("ESP32 BLE Circadian Sensor - Booting");

  // Initialize sensors (non-fatal)
  setupSensors();

  // BLE setup
  BLEDevice::init("ESP32_Sensor_Hub"); // device name shown in scans
  BLEServer *pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());

  BLEService *pService = pServer->createService(*
