 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Human Circadian Health Monitor — BLE Dashboard</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system,'Segoe UI',Roboto,Arial;color:#0b1220}
    body{margin:0;padding:18px;background:#f6fbff;color:#0b1220}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
    button, select{background:#0b69ff;border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
    .card{background:white;border:1px solid #e6eef8;padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(10,60,120,0.06)}
    .row{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .chart-wrap{height:320px;overflow:hidden}
    canvas{background:linear-gradient(180deg,#ffffff,#f7fbff);border-radius:8px;display:block;width:100%!important;height:320px!important}
    label{font-size:13px;color:#416387}
    .metrics div{margin-bottom:6px}
    .alert{padding:10px;border-radius:8px;margin-bottom:8px}
    .alert.ok{background:#e6f9ee;color:#047a3f}
    .alert.warn{background:#fff3df;color:#a65b00}
    .alert.bad{background:#ffe6e6;color:#9b1c1c}
    footer{margin-top:16px;color:#6a8aa4}
    #errorBox{position:fixed;right:12px;bottom:12px;max-width:360px;z-index:9999}
    #errorBox .err{background:#fff2f2;border:1px solid #ffb3b3;padding:10px;border-radius:8px;color:#7a1414;margin-top:8px}
    #status {font-size:13px;color:#234;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Human Circadian Health Monitor</h1>
      <div style="margin-left:auto;color:#416387;font-size:13px" id="status">Status: Idle</div>
    </header>

    <div class="controls">
      <button id="connectBtn">Connect to Device</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
      <select id="deviceMode"><option value="service">Filter by Service</option><option value="name">Filter by Name</option><option value="all">Show All Devices</option></select>
      <button id="genDemo">Generate Demo</button>
      <button id="exportPNG">Export Chart PNG</button>
    </div>

    <div class="row">
      <div class="card">
        <label>Live Charts</label>
        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>

        <div style="display:flex;gap:10px;margin-top:8px">
          <div class="card" style="flex:1;padding:10px">
            <label>Current Readings</label>
            <div class="metrics" id="metrics">
              <div>Device: <b id="devName">—</b></div>
              <div>Brightness (C): <b id="curC">—</b></div>
              <div>Blue Ratio: <b id="curBlue">—</b></div>
              <div>Activity (mag): <b id="curAct">—</b></div>
              <div>State: <b id="curState">—</b></div>
            </div>
          </div>
          <div class="card" style="width:220px">
            <label>Circadian Alerts</label>
            <div id="alerts"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <label>Summary</label>
        <div style="margin-top:8px">
          <div>Records: <span id="recCount">0</span></div>
          <div>Avg Activity: <span id="avgAct">—</span></div>
          <div>Avg Brightness: <span id="avgC">—</span></div>
          <div style="margin-top:10px"><b>Circadian Score:</b> <span id="circScore">—</span></div>
        </div>
        <hr style="margin:12px 0">
        <label>Future Scope (speak this):</label>
        <small>Wearable band with ESP32-C3, small battery, and onboard logging. Cost ~₹500. No cloud needed.</small>
      </div>
    </div>
    <footer>
      Tip: Close other Bluetooth apps (nRF Connect) before connecting. Use Chrome/Edge and open via HTTPS (GitHub Pages) or localhost.
    </footer>
  </div>

  <div id="errorBox"></div>

<script>
(function(){
  'use strict';
  // === Config ===
  const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
  const ACCEL_CHAR = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
  const RGB_CHAR   = 'beb5483e-36e1-4688-b7f5-ea07361b26b0';

  const BRIGHTNESS_THRESHOLD = 200;
  const BLUE_RATIO_NIGHT = 0.35;
  const NIGHT_START = 19, NIGHT_END = 23;
  const MORNING_START = 6, MORNING_END = 10;
  const STILL_THRESHOLD = 0.15, ACTIVE_THRESHOLD = 1.2;

  const MAX_RECORDS = 120;
  const CHART_THROTTLE_MS = 250;

  // === State ===
  let device=null, server=null, accelChar=null, rgbChar=null;
  let records = [], lastAccel=null, lastRGB=null, chartDirty=false, lastChartUpdate=0;

  // === DOM helpers ===
  const $ = id => document.getElementById(id);
  const setStatus = s => { const el = $('status'); if(el) el.innerText = 'Status: ' + s; };

  // === Chart ===
  const ctx = $('mainChart') ? $('mainChart').getContext('2d') : null;
  const mainChart = ctx ? new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[
      {label:'Activity (g)', data:[], yAxisID:'y1', borderColor:'#ff6384', fill:false},
      {label:'Brightness (C)', data:[], yAxisID:'y2', borderColor:'#36a2eb', fill:false},
      {label:'Blue Ratio', data:[], yAxisID:'y3', borderColor:'#ffcd56', fill:false}
    ]},
    options:{
      animation:false,responsive:true,maintainAspectRatio:false,
      scales:{x:{type:'category',ticks:{autoSkip:true,maxTicksLimit:20}}, y1:{position:'left'}, y2:{position:'right',grid:{drawOnChartArea:false}}, y3:{display:false}},
      plugins:{legend:{position:'top'}}
    }
  }) : null;

  // === Utils ===
  function reportError(err){
    console.error(err);
    const box = $('errorBox'); if(!box) return;
    const el = document.createElement('div'); el.className='err'; el.innerHTML = '<b>Error:</b> '+(err && err.message ? err.message : String(err));
    box.prepend(el); setTimeout(()=>{ try{ el.remove(); }catch(e){} },20000);
  }
  function pushAlert(text,level){ const box = $('alerts'); if(!box) return; const el = document.createElement('div'); el.className='alert '+(level||'warn'); el.innerText=text; box.prepend(el); while(box.children.length>4) box.removeChild(box.lastChild); }
  function parseCSVString(s){ if(typeof s!=='string') return []; re
